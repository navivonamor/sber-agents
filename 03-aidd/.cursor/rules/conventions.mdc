---
alwaysApply: true
---
# Правила разработки кода

Правила для code-ассистента при генерации кода для проекта.

## Общие принципы

- **KISS**: Выбирай самое простое решение. Избегай абстракций, паттернов, классов без необходимости.
- **YAGNI**: Реализуй только то, что нужно сейчас. Не добавляй "на будущее".
- **Один файл**: Вся логика бота в `src/bot.py`. Не создавай дополнительные модули без явной необходимости.

## Структура кода

- Используй функции, не классы (кроме случаев, когда класс обязателен для библиотеки).
- Группируй код по функциональности комментариями: `# Telegram Handler`, `# LLM Client`, `# Dialog Manager`.
- Константы в начале файла (системный промпт, лимиты, настройки).
- Переменные окружения загружай через `python-dotenv` в начале `main()`.

## Стиль кода

- Следуй PEP 8 (используй `ruff` или `black` для форматирования).
- Именование: `snake_case` для функций и переменных, `UPPER_CASE` для констант.
- Типизация: используй type hints для основных функций (не обязательно для всех).
- Docstrings: только для публичных функций, краткие (1-2 строки).

## Асинхронность

- Все обработчики Telegram — `async` функции.
- Все вызовы LLM API — `await`.
- Используй `asyncio.gather()` только если действительно нужен параллелизм.

## Обработка ошибок

- Обрабатывай ошибки на уровне обработчиков сообщений.
- Логируй ошибки с полным traceback (`logger.exception()`).
- Уведомляй пользователя простым сообщением при ошибке.
- Не падай молча — всегда логируй ошибку.

## Работа с данными

- История диалога: `dict[int, list[dict]]` — `{chat_id: [{"role": "...", "content": "..."}]}`.
- Ограничение истории: удаляй самые старые сообщения при превышении лимита (10 сообщений).
- Не используй БД, файлы, кеш — только in-memory словарь.

## Работа с LLM

- Используй OpenAI client с `base_url="https://openrouter.ai/api/v1"`.
- Системный промпт добавляй как первое сообщение с `role: "system"`.
- Температура: `0.7` (константа).
- Обрабатывай пустые ответы и ошибки API.

## Логирование

- Используй `logging` модуль (не `print`).
- Уровень: `INFO` для основных событий, `ERROR` для ошибок.
- Формат: стандартный с timestamp.
- Логируй: запуск/остановку, получение/отправку сообщений, запросы к LLM, ошибки.

## Конфигурация

- Загружай переменные окружения через `load_dotenv()`.
- Проверяй наличие обязательных переменных при старте (выброс ошибки с понятным сообщением).
- Константы в коде: системный промпт, температура, лимит истории.

## Запрещено

- Создавать классы без необходимости (кроме обязательных для библиотек).
- Создавать дополнительные файлы/модули без явной необходимости.
- Использовать БД, файлы для хранения данных.
- Добавлять функциональность "на будущее".
- Использовать сложные паттерны проектирования.
- Создавать абстракции "на всякий случай".

## Рекомендуется

- Писать простой, читаемый код.
- Использовать встроенные типы Python (dict, list).
- Обрабатывать ошибки явно.
- Логировать ключевые события.
- Проверять переменные окружения при старте.

